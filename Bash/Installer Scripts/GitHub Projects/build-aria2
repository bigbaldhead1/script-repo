#!/usr/bin/env bash

##  GitHub Script: https://github.com/slyfox1186/script-repo/blob/main/Bash/Installer%20Scripts/GitHub%20Projects/build-aria2
##  Purpose: Build aria2 from source code
##  Updated: 12.03.23
##  Script version: 1.8
##  Features:
##            - Static build
##            - OpenSSL backend
##            - Increased the max connections from 16 to 128
##  Added:
##         - Updated Aria2 to the latest version - 1.37.0
##         - If OpenSSL is manually installed using the build-openssl script then use its certs directory instead of the default.
##         - Build jemalloc from the latest source code
##         - RUNPATH to LDFLAGS
##  Fixed: Soft linking error

# Exit on error and uninitialized variables
set -euo pipefail
clear

# Script and Aria2 version
script_ver="1.8"
aria2_ver="1.37.0"

# Check for non-root execution
if [ "$EUID" -eq 0 ]; then
    echo 'This script must be run without root/sudo privileges.'
    exit 1
fi

# Function to handle errors
handle_error() {
    echo "Error occurred: $1"
    exit 1
}

# Determine OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=${NAME%% *}
    echo "Detected OS: $OS"
elif command -v lsb_release >/dev/null; then
    OS=$(lsb_release -si)
    echo "Detected OS: $OS"
else
    handle_error 'Unable to determine operating system.'
fi

# Directories and URLs
build_dir="$HOME/aria2-build"
install_dir="/usr/local"
archive_url="https://github.com/aria2/aria2/releases/download/release-$aria2_ver/aria2-$aria2_ver.tar.xz"
certs_dir="$(pkg-config --variable=libdir openssl)"

# Prepare build directory
echo "Creating build directory: $build_dir"
mkdir -p "$build_dir" && cd "$build_dir"

# Download and extract Aria2
echo "Downloading and extracting Aria2..."
curl -sL "$archive_url" | tar -xJ || handle_error "Failed to download and extract Aria2"

# Build jemalloc
printf '\n%s\n%s\n\n' 'Compiling jemalloc...' '================================'
jemalloc_ver="5.3.0"
jemalloc_url="https://github.com/jemalloc/jemalloc/releases/download/$jemalloc_ver/jemalloc-$jemalloc_ver.tar.bz2"
curl -sL "$jemalloc_url" | tar -xj || handle_error "Failed to download jemalloc"
cd "jemalloc-$jemalloc_ver"
./configure --prefix="$install_dir" || handle_error "Failed to configure jemalloc"
make -j"$(nproc)" && sudo make install || handle_error "Failed to build and install jemalloc"
cd ..

# Build gcrypt-error
printf '\n%s\n%s\n\n' 'Compiling gcrypt-error...' '================================'
gcrypt_error_ver="1.47"
gcrypt_error_url="https://gnupg.org/ftp/gcrypt/libgpg-error/libgpg-error-$gcrypt_error_ver.tar.bz2"
curl -sL "$gcrypt_error_url" | tar -xj || handle_error "Failed to download gcrypt-error"
cd "libgpg-error-$gcrypt_error_ver"
./configure --prefix="$install_dir" || handle_error "Failed to configure gcrypt-error"
make -j"$(nproc)" && sudo make install || handle_error "Failed to build and install gcrypt-error"
cd ..

# Compile Aria2
printf '\n%s\n%s\n\n' 'Compiling Aria2...' '================================'
cd "aria2-$aria2_ver"
sed -i 's/1, 16/1, 128/g' 'src/OptionHandlerFactory.cc'
./configure --prefix="$install_dir" --without-gnutls --with-openssl \
            --with-ca-bundle="$certs_dir/cacert.pem" \
            CFLAGS='-O3 -march=native' CXXFLAGS='-O3 -march=native' || handle_error "Failed to configure Aria2"
make -j"$(nproc)" || handle_error "Failed to build Aria2"
sudo make install || handle_error "Failed to install Aria2"

# Cleanup
printf '\n%s' 'Cleaning up...'
rm -rf "$build_dir"

printf '\n%s\n\n' "Aria2 version $aria2_ver installed successfully."
