#!/bin/bash

#################################################################
##
##  GitHub Repository:
##
##      https://github.com/slyfox1186/ffmpeg-build-script/
##
##  Forked Repository:
##
##      https://github.com/markus-perl/ffmpeg-build-script/
##
##  Target Distro:
##
##      Ubuntu Jammy 22.04.1 ( x86_x64 )
##
##  Purpose:
##
##      Build FFmpeg from source code with additional compiled
##      libraries to enable extra functionality
##
#################################################################

clear

# VERIFY THE SCRIPT DOES NOT HAVE ROOT ACCESS BEFORE CONTINUING
# THIS CAN CAUSE ISSUES USING THE 'IF WHICH' COMMANDS WHEN RUN AS ROOT
if [ "${EUID}" -lt '1' ]; then
    echo 'You must run this script as WITHOUT root/sudo'
    echo
    exit 1
fi

##
## Define Variables
##

PROGNAME="${0:2}"
# FFmpeg v5.1.2 Codename: Riemann
FFMPEG_VERSION='c0bc804e552bf6b21ae7da9cfeefe7405e380add'
SCRIPT_VERSION='2.00'
PACKAGES="${PWD}"/packages
WORKSPACE="${PWD}"/workspace
INSTALLDIR='/usr/bin'
CFLAGS="-I${WORKSPACE}"/include
LDFLAGS="-L${WORKSPACE}"/lib
LDEXEFLAGS=''
EXTRALIBS='-ldl -lpthread -lm -lz'
CONFIGURE_OPTIONS=()
NONFREE_AND_GPL='false'
LATEST='false'

##
## SET THE AVAILABLE CPU COUNT FOR PARALLEL PROCESSING (SPEEDS UP THE BUILD PROCESS)
##

if [ -f '/proc/cpuinfo' ]; then
    CPUS="$(grep -c processor '/proc/cpuinfo')"
else
    CPUS="$(nproc --all)"
fi

##
## FUNCTIONS
##

exit_fn()
{
    echo
    echo 'The script has finished!'
    echo
    echo 'Make sure to start this repository to show your suppport!'
    echo
    exit 0
}

make_dir()
{
    remove_dir "${1}"
    if ! mkdir "${1}"; then
        printf "\n Failed to create dir %s" "${1}"
        exit 1
    fi
}

remove_dir() {
    if [ -d "${1}" ]; then
        rm -r "${1}"
    fi
}

download()
{

    DOWNLOAD_PATH="${PACKAGES}"
    DOWNLOAD_FILE="${2:-"${1##*/}"}"

    if [[ "${DOWNLOAD_FILE}" =~ tar. ]]; then
        TARGET_DIR="${DOWNLOAD_FILE%.*}"
        TARGET_DIR="${3:-"${TARGET_DIR%.*}"}"
    else
        TARGET_DIR="${3:-"${DOWNLOAD_FILE%.*}"}"
    fi

    if [ ! -f "${DOWNLOAD_PATH}/${DOWNLOAD_FILE}" ]; then
        echo "Downloading ${1} as ${DOWNLOAD_FILE}"
        curl --progress-bar -Lso "${DOWNLOAD_PATH}/${DOWNLOAD_FILE}" "${1}"

        EXITCODE="${?}"
        if [ "${EXITCODE}" -ne '0' ]; then
            echo
            echo "Failed to download ${1}. Exitcode ${EXITCODE}. Retrying in 10 seconds"
            echo
            read -t 10 -p 'Press enter to skip waiting.'
            echo
            curl --progress-bar -Lso "${DOWNLOAD_PATH}/${DOWNLOAD_FILE}" "${1}"
        fi

        EXITCODE="${?}"
        if [ "${EXITCODE}" -ne '0' ]; then
            echo
            echo "Failed to download ${1}. Exitcode ${EXITCODE}"
            exit 1
        fi

        echo 'Download Complete...'
        echo
    else
        echo "${DOWNLOAD_FILE} has already downloaded."
fi

    make_dir "${DOWNLOAD_PATH}/${TARGET_DIR}"

    if [[ "${DOWNLOAD_FILE}" == *'patch'* ]]; then
        return
    fi

    if [ -n "${3}" ]; then
        if ! tar -xf "${DOWNLOAD_PATH}/${DOWNLOAD_FILE}" -C "${DOWNLOAD_PATH}/${TARGET_DIR}" 2>/dev/null >/dev/null; then
            echo "Failed to extract ${DOWNLOAD_FILE}"
            exit 1
        fi
    else
        if ! tar -xf "${DOWNLOAD_PATH}/${DOWNLOAD_FILE}" -C "${DOWNLOAD_PATH}/${TARGET_DIR}" --strip-components 1 2>/dev/null >/dev/null; then
            echo "Failed to extract ${DOWNLOAD_FILE}"
            exit 1
        fi
    fi

    echo "Extracted ${DOWNLOAD_FILE}"

    cd "${DOWNLOAD_PATH}/${TARGET_DIR}" || (
        echo 'Script error!'
        echo
        echo "Unable to cd into: ${TARGET_DIR}"
        echo
        exit 1
    )

}

execute()
{
    echo "$ ${*}"

    OUTPUT=$("${@}" 2>&1)

    # shellcheck disable=SC2181
    if [ "${?}" -ne '0' ]; then
        echo "${OUTPUT}"
        echo
        echo "Failed to Execute ${*}" >&2
        exit 1
    fi
}

# build command function
build()
{
    echo
    echo "building ${1} - version ${2}"
    echo "===================================="

    if [ -f "${PACKAGES}/${1}.done" ]; then
        if grep -Fx "${2}" "${PACKAGES}/${1}.done" >/dev/null; then
            echo "${1} version ${2} already built. Remove ${PACKAGES}/${1}.done lockfile to rebuild it."
            return 1
        elif ${LATEST}; then
            echo "${1} is outdated and will be rebuilt with latest version ${2}"
            return 0
        else
            echo "${1} is outdated, but will not be rebuilt. Pass in --latest to rebuild it or remove ${PACKAGES}/${1}.done lockfile."
            return 1
        fi
    fi

    return 0
}

command_exists()
{
    if ! [[ -x $(command -v "${1}") ]]; then
        return 1
    fi

    return
}

library_exists()
{

    if ! [[ -x "$(pkg-config --exists --print-errors "${1}" 2>&1 >/dev/null)" ]]; then
        return 1
    fi

    return 0
}

# confirm a build has completed function
build_done() { echo "${2}" > "${PACKAGES}/${1}.done"; }

verify_binary_type()
{
    if ! command_exists 'file'; then
        return
    fi

    BINARY_TYPE=$(file "${WORKSPACE}"/bin/ffmpeg | sed -n 's/^.*\:\ \(.*$\)/\1/p')
    echo
    case ${BINARY_TYPE} in
    'Mach-O 64-bit executable arm64')
        echo "Successfully built Apple Silicon (M1) for ${OSTYPE}: ${BINARY_TYPE}"
         ;;
    *)
          echo "Successfully built binary for ${OSTYPE}: ${BINARY_TYPE}"
          ;;
    esac
}

# cleanup all files function
cleanup()
{
    remove_dir "${PACKAGES}"
    remove_dir "${WORKSPACE}"
    echo 'Cleanup finished.'
    echo
}

# function to determine if a package is installed or not
installed() { return $(dpkg-query -W -f '${Status}\n' "${1}" 2>&1 | awk '/ok installed/{print 0;exit}{print 1}'); }

cuda_fail_fn()
{
    clear
    echo 'Unable to locate the required directory used in building the hardware acceleration libraries: /usr/local/cuda-12.0/bin'
    echo
    read -p 'Press enter to exit.'
    clear
    echo
    exit 1
}

# print the options available when manually running the script
usage()
{
    echo "Usage: ${PROGNAME} [OPTIONS]"
    echo
    echo 'Options:'
    echo '    -h, --help                                         Display usage information'
    echo '            --version                                    Display version information'
    echo '    -b, --build                                        Starts the build process'
    echo '            --enable-gpl-and-non-free    Enable GPL and non-free codecs    - https://ffmpeg.org/legal.html'
    echo '    -c, --cleanup                                    Remove all working dirs'
    echo '            --latest                                     Build latest version of dependencies if newer available'
    echo '            --full-static                            Build a full static FFmpeg binary (eg. glibc, pthreads etc...) **only Linux**'
    echo '                                                                 Note: Because of the NSS (Name Service Switch), glibc does not recommend static links.'
    echo
}

echo "ffmpeg-build-script v${SCRIPT_VERSION}"
echo '========================='
echo

while (($# > 0)); do
    case ${1} in
    -h | --help)
        usage
        exit 0
        ;;
    --version)
        echo "${SCRIPT_VERSION}"
        exit 0
        ;;
    -*)
        if [[ "${1}" == "--build" || "${1}" =~ '-b' ]]; then
            bflag='-b'
        fi
        if [[ "${1}" == "--enable-gpl-and-non-free" ]]; then
            CONFIGURE_OPTIONS+=("--enable-nonfree")
            CONFIGURE_OPTIONS+=("--enable-gpl")
            NONFREE_AND_GPL='true'
        fi
        if [[ "${1}" == "--cleanup" || "${1}" =~ '-c' && ! "${1}" =~ '--' ]]; then
            cflag='-c'
            cleanup
        fi
        if [[ "${1}" == "--full-static" ]]; then
            if [[ "${OSTYPE}" == "darwin"* ]]; then
                echo "Error: A full static binary can only be build on Linux."
                exit 1
            fi
        LDEXEFLAGS="-static"
        fi
        if [[ "${1}" == "--latest" ]]; then
            LATEST='true'
        fi
        shift
        ;;
    *)
        usage
        exit 1
        ;;
    esac
done

if [ -z "${bflag}" ]; then
    if [ -z "${cflag}" ]; then
        usage
        exit 1
    fi
    exit 0
fi

echo "Using ${CPUS} processors for parallel processing to speed up the make jobs building speed."
echo

if ${NONFREE_AND_GPL}; then
    echo 'The script has been configured to run with GPL and non-free codecs enabled'
    echo
fi

if [ -n "${LDEXEFLAGS}" ]; then
    echo 'The script has been configured to run in full static mode.'
    echo
fi

mkdir -p "${PACKAGES}"
mkdir -p "${WORKSPACE}"

PATH="${WORKSPACE}/bin:${PATH}"
export PATH

PKG_CONFIG_PATH="\
/usr/local/lib/x86_64-linux-gnu/pkgconfig:\
/usr/local/lib/pkgconfig:\
/usr/local/share/pkgconfig:\
/usr/lib/x86_64-linux-gnu/pkgconfig:\
/usr/lib/pkgconfig:\
/usr/share/pkgconfig:\
/usr/lib64/pkgconfig\
"
export PKG_CONFIG_PATH

#PKG_CONFIG_PATH="/usr/local/lib/x86_64-linux-gnu/pkgconfig:/usr/local/lib/pkgconfig"
#PKG_CONFIG_PATH+=":/usr/local/share/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:/usr/lib64/pkgconfig"

if ! command_exists 'make'; then
    echo 'The '\''make'\'' package is not installed. It is required for this script to run.'
    exit 1
fi

if ! command_exists 'g++'; then
    echo 'The '\''g++'\'' package is not installed. It is required for this script to run.'
    exit 1
fi

if ! command_exists 'curl'; then
    echo 'The '\''curl'\'' package is not installed. It is required for this script to run.'
    exit 1
fi

if ! command_exists 'cargo'; then
    echo 'The '\''cargo'\'' command was not found. rav1e encoder will not be available.'
fi

if ! command_exists 'python3'; then
    echo 'The '\''python3'\'' command was not found. The '\''Lv2'\'' filter and '\''dav1d'\'' decoder will not be available.'
fi

##
## CUDA Functions
##

cuda_fn()
{
    clear
    echo 'Pick your distribution'
    echo
    echo '[1] Debian Linux 10 (x86_x64)'
    echo '[2] Debian Linux 11 (x86_x64)'
    echo '[3] Ubuntu Linux 18.04 (x86_x64)'
    echo '[4] Ubuntu Linux 20.04 (x86_x64)'
    echo '[5] Ubuntu Linux 22.04 (x86_x64)'
    echo '[6] Ubuntu WSL 2 (Windows Subsystem for Linux)'
    echo '[7] Return'
    echo
    read -p 'Your choices are (1 to 7): ' CUDA_DIST
    clear
    if [[ "${CUDA_DIST}" -eq '1' ]]; then
        wget --show progress -cqO 'cuda-12.deb' 'https://developer.download.nvidia.com/compute/cuda/12.0.0/local_installers/cuda-repo-debian10-12-0-local_12.0.0-525.60.13-1_amd64.deb'
        sudo dpkg -i 'cuda-12.deb'
        sudo cp /var/cuda-repo-debian10-12-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
        sudo add-apt-repository contrib
        sudo apt update
        sudo apt -y install cuda
        if [ ! -d '/usr/local/cuda-12.0/bin' ]; then cuda_fail_fn; fi
        PATH="${PATH}:/usr/local/cuda-12.0/bin"
        export PATH
       elif [[ "${CUDA_DIST}" -eq '2' ]]; then
        wget --show progress -cqO 'cuda-12.deb' 'https://developer.download.nvidia.com/compute/cuda/12.0.0/local_installers/cuda-repo-debian11-12-0-local_12.0.0-525.60.13-1_amd64.deb'
        sudo dpkg -i 'cuda-12.deb'
        sudo cp /var/cuda-repo-debian11-12-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
        sudo add-apt-repository contrib
        sudo apt update
        sudo apt -y install cuda
        if [ ! -d '/usr/local/cuda-12.0/bin' ]; then cuda_fail_fn; fi
        PATH="${PATH}:/usr/local/cuda-12.0/bin"
        export PATH
    elif [[ "${CUDA_DIST}" -eq '3' ]]; then
        wget --show progress -cq 'https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-ubuntu1804.pin'
        sudo mv cuda-ubuntu1804.pin /etc/apt/preferences.d/cuda-repository-pin-600
        wget --show progress -cqO 'cuda-12.deb' 'https://developer.download.nvidia.com/compute/cuda/12.0.0/local_installers/cuda-repo-ubuntu1804-12-0-local_12.0.0-525.60.13-1_amd64.deb'
        sudo dpkg -i 'cuda-12.deb'
        sudo cp /var/cuda-repo-ubuntu1804-12-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
        sudo apt update
        sudo apt -y install cuda
        if [ ! -d '/usr/local/cuda-12.0/bin' ]; then cuda_fail_fn; fi
        PATH="${PATH}:/usr/local/cuda-12.0/bin"
        export PATH
    elif [[ "${CUDA_DIST}" -eq '4' ]]; then
        wget --show progress -cq 'https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin'
        sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
        wget --show progress -cqO 'cuda-12.deb' 'https://developer.download.nvidia.com/compute/cuda/12.0.0/local_installers/cuda-repo-ubuntu2004-12-0-local_12.0.0-525.60.13-1_amd64.deb'
        sudo dpkg -i 'cuda-12.deb'
        sudo cp /var/cuda-repo-ubuntu2004-12-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
        sudo apt update
        sudo apt -y install cuda
        if [ ! -d '/usr/local/cuda-12.0/bin' ]; then cuda_fail_fn; fi
        PATH="${PATH}:/usr/local/cuda-12.0/bin"
        export PATH
    elif [[ "${CUDA_DIST}" -eq '5' ]]; then
        wget --show progress -cq 'https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin'
        sudo mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600
        wget --show progress -cqO 'cuda-12.deb' 'https://developer.download.nvidia.com/compute/cuda/12.0.0/local_installers/cuda-repo-ubuntu2204-12-0-local_12.0.0-525.60.13-1_amd64.deb'
        sudo dpkg -i 'cuda-12.deb'
        sudo cp /var/cuda-repo-ubuntu2204-12-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
        sudo apt update
        sudo apt -y install cuda
        if [ ! -d '/usr/local/cuda-12.0/bin' ]; then cuda_fail_fn; fi
        PATH="${PATH}:/usr/local/cuda-12.0/bin"
        export PATH
    elif [[ "${CUDA_DIST}" -eq '6' ]]; then
        wget --show progress -cq 'https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-wsl-ubuntu.pin'
        sudo mv cuda-wsl-ubuntu.pin /etc/apt/preferences.d/cuda-repository-pin-600
        wget --show progress -cqO 'cuda-12.deb' 'https://developer.download.nvidia.com/compute/cuda/12.0.0/local_installers/cuda-repo-wsl-ubuntu-12-0-local_12.0.0-1_amd64.deb'
        sudo dpkg -i 'cuda-12.deb'
        sudo cp /var/cuda-repo-wsl-ubuntu-12-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
        sudo apt update
        sudo apt -y install cuda
        if [ ! -d '/usr/local/cuda-12.0/bin' ]; then cuda_fail_fn; fi
        PATH="${PATH}:/usr/local/cuda-12.0/bin"
        export PATH
    elif [[ "${CUDA_DIST}" -eq '7' ]]; then
        return 0
    fi
}

##
## Install CUDA
##

if ! which nvcc &> /dev/null; then
    echo
    echo 'You don'\''t have the CUDA toolkit installed OR you don'\''t have it in your $PATH.'
    echo
    echo 'Do you want to install it?'
    echo
    echo '[1] Yes'
    echo '[2] No'
    echo '[3] Exit'
    echo
    read -p 'Your choices are (1 to 3): ' CUDA_ANS
    clear
    if [[ "${CUDA_ANS}" -eq '1' ]]; then
        cuda_fn
    elif [[ "${CUDA_ANS}" -eq '2' ]]; then
        if [ -d '/usr/local/cuda-12.0/bin' ]; then
            PATH="${PATH}:/usr/local/cuda-12.0/bin"
            export PATH
        fi
        clear
    elif [[ "${CUDA_ANS}" -eq '3' ]]; then
        exit 0
    else
        clear
        echo 'Bad user input.'
        echo
        read -p 'Press enter to exit.'
        clear
        exit 1
    fi
else
    echo
    echo 'The CUDA development libraries are installed and ready to be built.'
fi

##
## Geforce CUDA Required Developement Packages
##

echo
echo 'Installing: Geforce CUDA Required Developement Packages'
echo '=========================================='

CUDA_PKGS=(build-essential libc6 libc6-dev libnuma-dev libnuma1 libtool unzip wget)

for CUDA_PKG in ${CUDA_PKGS[@]}
do
    if ! installed "${CUDA_PKG}"; then
        MISSING_CUDA_PKGS+=" ${CUDA_PKG}"
    fi
done

if [ -n "${MISSING_CUDA_PKGS}" ]; then
    sudo apt install "${MISSING_CUDA_PKGS}"
else
    echo 'The Geforce developement libraries required for hardware acceleration have been installed.'
fi

##
## build tools
##

if build 'giflib' '5.2.1'; then
    download 'https://netcologne.dl.sourceforge.net/project/giflib/giflib-5.2.1.tar.gz'
    cd "${PACKAGES}"/giflib-5.2.1 || exit 1
    #multicore build disabled for this library
    execute make
    execute make PREFIX="${WORKSPACE}" install
    build_done 'giflib' '5.2.1'
fi

if build 'pkg-config' '0.29.2'; then
    download 'https://pkgconfig.freedesktop.org/releases/pkg-config-0.29.2.tar.gz'
    execute ./configure --silent --prefix="${WORKSPACE}" --with-pc-path="${WORKSPACE}"/lib/pkgconfig --with-internal-glib
    execute make "-j${CPUS}"
    execute make install
    build_done 'pkg-config' '0.29.2'
fi

if build 'yasm' '1.3.0'; then
    download 'https://github.com/yasm/yasm/releases/download/v1.3.0/yasm-1.3.0.tar.gz'
    execute ./configure --prefix="${WORKSPACE}"
    execute make "-j${CPUS}"
    execute make install
    build_done 'yasm' '1.3.0'
fi

if build 'nasm' '2.16.01'; then
    download 'https://www.nasm.us/pub/nasm/releasebuilds/2.16.01/nasm-2.16.01.tar.xz'
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
    execute make "-j${CPUS}"
    execute make install
    build_done 'nasm' '2.16.01'
fi

if build 'zlib' '1.2.13'; then
    download 'https://zlib.net/fossils/zlib-1.2.13.tar.gz'
    execute ./configure --static --prefix="${WORKSPACE}"
    execute make "-j${CPUS}"
    execute make install
    build_done 'zlib' '1.2.13'
fi

if build 'm4' '1.4.19'; then
    download 'https://ftp.gnu.org/gnu/m4/m4-1.4.19.tar.xz'
    execute ./configure --prefix="${WORKSPACE}"
    execute make "-j${CPUS}"
    execute make install

    build_done 'm4' '1.4.19'
fi

if build 'autoconf' '2.71'; then
    download 'https://ftp.gnu.org/gnu/autoconf/autoconf-2.71.tar.xz'
    execute ./configure --prefix="${WORKSPACE}"
    execute make "-j${CPUS}"
    execute make install
    build_done 'autoconf' '2.71'
fi

if build 'automake' '1.16.5'; then
    download 'https://ftp.gnu.org/gnu/automake/automake-1.16.5.tar.xz'
    execute ./configure --prefix="${WORKSPACE}"
    execute make "-j${CPUS}"
    execute make install
    build_done 'automake' '1.16.5'
fi

if build 'libtool' '2.4.7'; then
    download 'https://mirror.vern.cc/gnu/libtool/libtool-2.4.7.tar.xz'
    execute ./configure --prefix="${WORKSPACE}" --enable-static --disable-shared
    execute make "-j${CPUS}"
    execute make install
    build_done 'libtool' '2.4.7'
fi

if ${NONFREE_AND_GPL}; then
    if build 'openssl' '1.1.1s'; then
        download 'https://www.openssl.org/source/openssl-1.1.1s.tar.gz'
        execute ./config --prefix="${WORKSPACE}" --openssldir="${WORKSPACE}" --with-zlib-include="${WORKSPACE}"/include/ --with-zlib-lib="${WORKSPACE}"/lib no-shared zlib
        execute make "-j${CPUS}"
        execute make install_sw
        build_done 'openssl' '1.1.1s'
    fi
    CONFIGURE_OPTIONS+=('--enable-openssl')
else
    if build 'gmp' '6.2.1'; then
        download 'https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz'
        execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
        execute make "-j${CPUS}"
        execute make install
        build_done 'gmp' '6.2.1'
    fi

    if build 'nettle' '3.8.1'; then
        download 'https://ftp.gnu.org/gnu/nettle/nettle-3.8.1.tar.gz'
        execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static --disable-openssl \
        --disable-documentation --libdir="${WORKSPACE}"/lib CPPFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}"
        execute make "-j${CPUS}"
        execute make install
        build_done 'nettle' '3.8.1'
    fi

    if build 'gnutls' '3.7.8'; then
        download 'https://www.gnupg.org/ftp/gcrypt/gnutls/v3.7/gnutls-3.7.8.tar.xz'
        execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static --disable-doc --disable-tools \
        --disable-cxx --disable-tests --disable-gtk-doc-html --disable-libdane --disable-nls --enable-local-libopts \
        --disable-guile --with-included-libtasn1 --with-included-unistring --without-p11-kit CPPFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}"
        execute make "-j${CPUS}"
        execute make install
        build_done 'gnutls' '3.7.8'
    fi
    CONFIGURE_OPTIONS+=('--enable-gmp' '--enable-gnutls')
fi

if build 'cmake' '3.25.1'; then
    download 'https://github.com/Kitware/CMake/releases/download/v3.25.1/cmake-3.25.1.tar.gz'
    execute ./configure --prefix="${WORKSPACE}" --parallel="${CPUS}" -- -DCMAKE_USE_OPENSSL='OFF'
    execute make "-j${CPUS}"
    execute make install
    build_done 'cmake' '3.25.1'
fi

##
## video libraries
##

if command_exists 'python3'; then
    # dav1d needs meson and ninja along with nasm to be built
    if command_exists 'pip3'; then
        # meson and ninja can be installed via pip3
        execute pip3 install pip setuptools --quiet --upgrade --no-cache-dir --disable-pip-version-check
        for i in meson ninja; do
            if ! command_exists "${i}"; then
                execute pip3 install "${i}" --quiet --upgrade --no-cache-dir --disable-pip-version-check
            fi
        done
    fi
    if command_exists 'meson'; then
        if build 'dav1d' '1.0.0'; then
            download 'https://code.videolan.org/videolan/dav1d/-/archive/1.0.0/dav1d-1.0.0.tar.gz'
            make_dir build
            execute meson build --prefix="${WORKSPACE}" --buildtype='release' --default-library='static' --libdir="${WORKSPACE}"/lib
            execute ninja -C build
            execute ninja -C build install
            build_done 'dav1d' '1.0.0'
        fi
        CONFIGURE_OPTIONS+=('--enable-libdav1d')
    fi
fi

if build 'svtav1' '1.4.1'; then
    # Last known working commit which passed CI Tests from HEAD branch
    download 'https://gitlab.com/AOMediaCodec/SVT-AV1/-/archive/v1.4.1/SVT-AV1-v1.4.1.tar.gz' 'svtav1-1.4.1.tar.gz'
    cd "${PACKAGES}"/svtav1-1.4.1//Build/linux || exit 1
    execute cmake -DCMAKE_INSTALL_PREFIX="${WORKSPACE}" -DENABLE_SHARED='OFF' -DBUILD_SHARED_LIBS='OFF' ../.. -G 'Unix Makefiles' -DCMAKE_BUILD_TYPE='Release'
    execute make "-j${CPUS}"
    execute make install
    execute cp 'SvtAv1Enc.pc' "${WORKSPACE}"/lib/pkgconfig/
    execute cp 'SvtAv1Dec.pc' "${WORKSPACE}"/lib/pkgconfig/
    build_done 'svtav1' '1.4.1'
    fi
    CONFIGURE_OPTIONS+=('--enable-libsvtav1')

if command_exists 'cargo'; then
    if build 'rav1e' '0.5.0-beta'; then
        execute cargo install --version "0.9.14+cargo-0.66" cargo-c
        download 'https://github.com/xiph/rav1e/archive/refs/tags/v0.5.0-beta.tar.gz'
        execute cargo cinstall --prefix="${WORKSPACE}" --library-type='staticlib' --crt-static --release
        build_done 'rav1e' '0.5.0-beta'
    fi
    CONFIGURE_OPTIONS+=('--enable-librav1e')
fi

if ${NONFREE_AND_GPL}; then

    if build 'x264' '941cae6'; then
        download 'https://code.videolan.org/videolan/x264/-/archive/941cae6d1d6d6344c9a1d27440eaf2872b18ca9a/x264-941cae6d1d6d6344c9a1d27440eaf2872b18ca9a.tar.gz' 'x264-941cae6.tar.gz'
        cd "${PACKAGES}/x264-941cae6" || exit 1
        execute ./configure --prefix="${WORKSPACE}" --enable-static --enable-pic CXXFLAGS="-fPIC ${CXXFLAGS}"
        execute make "-j${CPUS}"
        execute make install
        execute make install-lib-static
        build_done 'x264' '941cae6'
    fi
    CONFIGURE_OPTIONS+=('--enable-libx264')
fi

if ${NONFREE_AND_GPL}; then
    if build 'x265' '3.5'; then
        download 'https://github.com/videolan/x265/archive/refs/tags/3.4.tar.gz' 'x265-3.5.tar.gz' # This is actually 3.4 if looking at x265Version.txt
        cd 'build/linux' || exit 1
        rm -rf {8,10,12}bit 2>/dev/null
        mkdir -p {8,10,12}bit
        cd '12bit' || exit 1
        echo '$ making 12bit binaries'
        execute cmake ../../../source -DCMAKE_INSTALL_PREFIX="${WORKSPACE}" -DENABLE_SHARED='OFF' -DBUILD_SHARED_LIBS='OFF' \
        -DHIGH_BIT_DEPTH='ON' -DENABLE_HDR10_PLUS='ON' -DEXPORT_C_API='OFF' -DENABLE_CLI='OFF' -DMAIN12='ON'
        execute make "-j${CPUS}"
        echo '$ making 10bit binaries'
        cd ../'10bit' || exit 1
        execute cmake ../../../source -DCMAKE_INSTALL_PREFIX="${WORKSPACE}" -DENABLE_SHARED='OFF' \
        -DBUILD_SHARED_LIBS='OFF' -DHIGH_BIT_DEPTH='ON' -DENABLE_HDR10_PLUS='ON' -DEXPORT_C_API='OFF' -DENABLE_CLI='OFF'
        execute make "-j${CPUS}"
        echo '$ making 8bit binaries'
        cd ../'8bit' || exit 1
        ln -sf ../'10bit/libx265.a' 'libx265_main10.a'
        ln -sf ../'12bit/libx265.a' 'libx265_main12.a'
        execute cmake ../../../'source' -DCMAKE_INSTALL_PREFIX="${WORKSPACE}" -DENABLE_SHARED='OFF' \
        -DBUILD_SHARED_LIBS='OFF' -DEXTRA_LIB='x265_main10.a;x265_main12.a;-ldl' -DEXTRA_LINK_FLAGS='-L.' -DLINKED_10BIT='ON' -DLINKED_12BIT='ON'
        execute make "-j${CPUS}"

        mv 'libx265.a' 'libx265_main.a'
        
            execute ar -M <<EOF
CREATE libx265.a
ADDLIB libx265_main.a
ADDLIB libx265_main10.a
ADDLIB libx265_main12.a
SAVE
END
EOF
        execute make install

        if [ -n "${LDEXEFLAGS}" ]; then
            sed -i.backup 's/-lgcc_s/-lgcc_eh/g' "${WORKSPACE}"/lib/pkgconfig/x265.pc
        fi

        build_done 'x265' '3.5'
    fi
    CONFIGURE_OPTIONS+=('--enable-libx265')
fi

if build 'libvpx' '1.12.0'; then
    download 'https://github.com/webmproject/libvpx/archive/refs/tags/v1.12.0.tar.gz' 'libvpx-1.12.0.tar.gz'
    execute ./configure --prefix="${WORKSPACE}" --disable-unit-tests --disable-shared --disable-examples --as='yasm'
    execute make "-j${CPUS}"
    execute make install

    build_done 'libvpx' '1.12.0'
fi
CONFIGURE_OPTIONS+=('--enable-libvpx')

if ${NONFREE_AND_GPL}; then
    if build 'xvidcore' '1.3.7'; then
        download 'https://downloads.xvid.com/downloads/xvidcore-1.3.7.tar.gz'
        cd 'build/generic' || exit 1
        execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
        execute make "-j${CPUS}"
        execute make install

        if [[ -f "${WORKSPACE}"/lib/libxvidcore.4.dylib ]]; then
            execute rm "${WORKSPACE}"/lib/libxvidcore.4.dylib
        fi

        if [[ -f "${WORKSPACE}"/lib/libxvidcore.so ]]; then
            execute rm "${WORKSPACE}"/lib/libxvidcore.so*
        fi

        build_done 'xvidcore' '1.3.7'
    fi
    CONFIGURE_OPTIONS+=('--enable-libxvid')
fi

if ${NONFREE_AND_GPL}; then
    if build 'vid_stab' '1.1.0'; then
        download 'https://github.com/georgmartius/vid.stab/archive/v1.1.0.tar.gz' 'vid.stab-1.1.0.tar.gz'
        execute cmake -DBUILD_SHARED_LIBS='OFF' -DCMAKE_INSTALL_PREFIX="${WORKSPACE}" -DUSE_OMP='OFF' -DENABLE_SHARED='OFF' .
        execute make
        execute make install
        build_done 'vid_stab' '1.1.0'
    fi
    CONFIGURE_OPTIONS+=('--enable-libvidstab')
fi

if build 'av1' 'bcfe6fb'; then
  # libaom bcfe6fb == v3.5.0
    download 'https://aomedia.googlesource.com/aom/+archive/2621615dfb7a6db45522c47f7495868d2fe01379.tar.gz' 'av1.tar.gz' 'av1'
    # download 'https://aomedia.googlesource.com/aom/+archive/bcfe6fbfed315f83ee8a95465c654ee8078dbff9.tar.gz' 'av1.tar.gz' 'av1'
    make_dir "${PACKAGES}/aom_build"
    cd "${PACKAGES}/aom_build" || exit 1
    execute cmake -DENABLE_TESTS='0' -DENABLE_EXAMPLES='0' -DCMAKE_INSTALL_PREFIX="${WORKSPACE}" -DCMAKE_INSTALL_LIBDIR='lib' "${PACKAGES}"/av1
    execute make "-j${CPUS}"
    execute make install
    build_done 'av1' '9904efe'
fi
CONFIGURE_OPTIONS+=('--enable-libaom')

if build 'zimg' '3.0.4'; then
    download 'https://github.com/sekrit-twc/zimg/archive/refs/tags/release-3.0.4.tar.gz' 'zimg-3.0.4.tar.gz' 'zimg'
    cd 'zimg-release-3.0.4' || exit 1
    execute "${WORKSPACE}"/bin/libtoolize -i -f -q
    execute ./autogen.sh --prefix="${WORKSPACE}"
    execute ./configure --prefix="${WORKSPACE}" --enable-static --disable-shared
    execute make "-j${CPUS}"
    execute make install
    build_done 'zimg' '3.0.4'
fi
CONFIGURE_OPTIONS+=('--enable-libzimg')

##
## audio libraries
##

if command_exists 'python3'; then

    if command_exists 'meson'; then

        if build 'lv2' '1.18.10'; then
            download 'https://lv2plug.in/spec/lv2-1.18.10.tar.xz' 'lv2-1.18.10.tar.xz'
            execute meson build --prefix="${WORKSPACE}" --buildtype='release' --default-library='static' --libdir="${WORKSPACE}"/lib
            execute ninja -C build
            execute ninja -C build install
            build_done 'lv2' '1.18.10'
        fi
        if build 'waflib' 'aeef9f5'; then
            download 'https://gitlab.com/drobilla/autowaf/-/archive/aeef9f5fdf416d9b68c61c75de7dae409f1ac6a4/autowaf-aeef9f5fdf416d9b68c61c75de7dae409f1ac6a4.tar.gz' 'autowaf.tar.gz'
            build_done 'waflib' 'aeef9f5'
        fi
        if build 'serd' '0.30.16'; then
            download 'https://gitlab.com/drobilla/serd/-/archive/v0.30.16/serd-v0.30.16.tar.gz' 'serd-v0.30.16.tar.gz'
            execute meson build --prefix="${WORKSPACE}" --buildtype='release' --default-library='static' --libdir="${WORKSPACE}"/lib
            execute ninja -C build
            execute ninja -C build install
            build_done 'serd' '0.30.16'
        fi
        if build 'pcre' '8.45'; then
            download 'https://altushost-swe.dl.sourceforge.net/project/pcre/pcre/8.45/pcre-8.45.tar.gz' 'pcre-8.45.tar.gz'
            execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
            execute make "-j${CPUS}"
            execute make install
            build_done 'pcre' '8.45'
        fi
        if build 'sord' '0.16.14'; then
            download 'https://gitlab.com/drobilla/sord/-/archive/v0.16.14/sord-v0.16.14.tar.gz' 'sord-v0.16.14.tar.gz'
            execute meson build --prefix="${WORKSPACE}" --buildtype='release' --default-library='static' --libdir="${WORKSPACE}"/lib
            execute ninja -C build
            execute ninja -C build install
            build_done 'sord' '0.16.14'
        fi
        if build 'sratom' '0.6.14'; then
            download 'https://gitlab.com/lv2/sratom/-/archive/v0.6.14/sratom-v0.6.14.tar.gz' 'sratom-v0.6.14.tar.gz'
            execute meson build --prefix="${WORKSPACE}" --buildtype='release' --default-library='static' --libdir="${WORKSPACE}"/lib
            execute ninja -C build
            execute ninja -C build install
            build_done 'sratom' '0.6.14'
        fi
        if build 'lilv' '0.24.20'; then
            download 'https://gitlab.com/lv2/lilv/-/archive/v0.24.20/lilv-v0.24.20.tar.gz' 'lilv-v0.24.20.tar.gz'
              execute meson build --prefix="${WORKSPACE}" --buildtype='release' --default-library='static' --libdir="${WORKSPACE}"/lib
            execute ninja -C build
            execute ninja -C build install
            build_done 'lilv' '0.24.20'
        fi
        CFLAGS+=" -I$WORKSPACE/include/lilv-0"

        CONFIGURE_OPTIONS+=('--enable-lv2')
    fi
fi

if build 'opencore' '0.1.6'; then
    download 'https://netactuate.dl.sourceforge.net/project/opencore-amr/opencore-amr/opencore-amr-0.1.6.tar.gz' 'opencore-amr-0.1.6.tar.gz'
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
    execute make "-j${CPUS}"
    execute make install
    build_done 'opencore' '0.1.6'
fi
CONFIGURE_OPTIONS+=('--enable-libopencore_amrnb' '--enable-libopencore_amrwb')

if build 'lame' '3.100'; then
    download 'https://sourceforge.net/projects/lame/files/lame/3.100/lame-3.100.tar.gz/download?use_mirror=gigenet' 'lame-3.100.tar.gz'
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
    execute make "-j${CPUS}"
    execute make install
    build_done 'lame' '3.100'
fi
CONFIGURE_OPTIONS+=('--enable-libmp3lame')

if build 'opus' '1.3.1'; then
    download 'https://archive.mozilla.org/pub/opus/opus-1.3.1.tar.gz'
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
    execute make "-j${CPUS}"
    execute make install
    build_done 'opus' '1.3.1'
fi
CONFIGURE_OPTIONS+=('--enable-libopus')

if build 'libogg' '1.3.5'; then
    download 'https://ftp.osuosl.org/pub/xiph/releases/ogg/libogg-1.3.5.tar.xz'
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
    execute make "-j${CPUS}"
    execute make install
    build_done 'libogg' '1.3.5'
fi

if build 'libvorbis' '1.3.7'; then
    download 'https://ftp.osuosl.org/pub/xiph/releases/vorbis/libvorbis-1.3.7.tar.xz'
    execute ./configure --prefix="${WORKSPACE}" --with-ogg-libraries="${WORKSPACE}"/lib --with-ogg-includes="${WORKSPACE}"/include/ --enable-static --disable-shared --disable-oggtest
    execute make "-j${CPUS}"
    execute make install
    build_done 'libvorbis' '1.3.7'
fi
CONFIGURE_OPTIONS+=('--enable-libvorbis')

if build 'libtheora' '1.1.1'; then
    download 'https://ftp.osuosl.org/pub/xiph/releases/theora/libtheora-1.1.1.tar.gz'
    sed "s/-fforce-addr//g" 'configure' >'configure.patched'
    chmod +x 'configure.patched'
    mv 'configure.patched' 'configure'
    rm 'config.guess'
    curl --progress-bar -Lso 'config.guess' 'https://raw.githubusercontent.com/gcc-mirror/gcc/master/config.guess'
    chmod +x 'config.guess'
    execute ./configure --prefix="${WORKSPACE}" --with-ogg-libraries="${WORKSPACE}"/lib --with-ogg-includes="${WORKSPACE}"/include/ \
    --with-vorbis-libraries="${WORKSPACE}"/lib --with-vorbis-includes="${WORKSPACE}"/include/ --enable-static --disable-shared \
    --disable-oggtest --disable-vorbistest --disable-examples --disable-asm --disable-spec
    execute make "-j${CPUS}"
    execute make install
    build_done 'libtheora' '1.1.1'
fi
CONFIGURE_OPTIONS+=('--enable-libtheora')

if ${NONFREE_AND_GPL}; then
    if build 'fdk_aac' '2.0.2'; then
        download 'https://sourceforge.net/projects/opencore-amr/files/fdk-aac/fdk-aac-2.0.2.tar.gz/download?use_mirror=gigenet' 'fdk-aac-2.0.2.tar.gz'
        execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static --enable-pic
        execute make "-j${CPUS}"
        execute make install
        build_done 'fdk_aac' '2.0.2'
    fi
    CONFIGURE_OPTIONS+=('--enable-libfdk-aac')
fi

##
## image libraries
##

if build 'libtiff' '4.5.0'; then
    download 'https://download.osgeo.org/libtiff/tiff-4.5.0.tar.xz'
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static --disable-dependency-tracking --disable-lzma --disable-webp --disable-zstd --without-x
    execute make "-j${CPUS}"
    execute make install
    build_done 'libtiff' '4.5.0'
fi
if build 'libpng' '1.6.39'; then
    download 'https://versaweb.dl.sourceforge.net/project/libpng/libpng16/1.6.39/libpng-1.6.39.tar.xz' 'libpng-1.6.39.tar.xz'
    export LDFLAGS="${LDFLAGS}"
    export CPPFLAGS="${CFLAGS}"
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
    execute make "-j${CPUS}"
    execute make install
    build_done 'libpng' '1.6.39'
fi

## does not compile on monterey -> _PrintGifError

if build 'libwebp' '1.2.2'; then
    CPPFLAGS=
    download 'https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.2.2.tar.gz'
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static --disable-dependency-tracking \
    --disable-gl --with-zlib-include="${WORKSPACE}"/include/ --with-zlib-lib="${WORKSPACE}"/lib
    make_dir build
    cd 'build' || exit 1
    execute cmake -DCMAKE_INSTALL_PREFIX="${WORKSPACE}" -DCMAKE_INSTALL_LIBDIR='lib' -DCMAKE_INSTALL_BINDIR='bin' \
    -DCMAKE_INSTALL_INCLUDEDIR='include' -DENABLE_SHARED='OFF' -DENABLE_STATIC='ON' ../
    execute make "-j${CPUS}"
    execute make install

    build_done 'libwebp' '1.2.2'
fi
CONFIGURE_OPTIONS+=('--enable-libwebp')

##
## other libraries
##

if build 'libsdl' '2.0.20'; then
    download 'https://www.libsdl.org/release/SDL2-2.0.20.tar.gz'
    execute ./configure --prefix="${WORKSPACE}" --disable-shared --enable-static
    execute make "-j${CPUS}"
    execute make install

    build_done 'libsdl' '2.0.20'
fi

if ${NONFREE_AND_GPL}; then
    if build 'srt' '1.4.3'; then
        download 'https://github.com/Haivision/srt/archive/v1.4.3.tar.gz' 'srt-1.4.3.tar.gz'
        export OPENSSL_ROOT_DIR="${WORKSPACE}"
        export OPENSSL_LIB_DIR="${WORKSPACE}"/lib
        export OPENSSL_INCLUDE_DIR="${WORKSPACE}"/include/
        execute cmake . -DCMAKE_INSTALL_PREFIX="${WORKSPACE}" -DCMAKE_INSTALL_LIBDIR='lib' -DCMAKE_INSTALL_BINDIR='bin' \
        -DCMAKE_INSTALL_INCLUDEDIR='include' -DENABLE_SHARED='OFF' -DENABLE_STATIC='ON' -DENABLE_APPS='OFF' -DUSE_STATIC_LIBSTDCXX='ON'
        execute make install

        if [ -n "${LDEXEFLAGS}" ]; then
            sed -i.backup 's/-lgcc_s/-lgcc_eh/g' "${WORKSPACE}"/lib/pkgconfig/srt.pc
        fi

        build_done 'srt' '1.4.3'
    fi
        CONFIGURE_OPTIONS+=('--enable-libsrt')
fi


#####################
## HWaccel library ##
#####################

if which 'nvcc' &> /dev/null; then
    if build 'nv-codec' '8.1.24.14'; then
        download 'https://github.com/FFmpeg/nv-codec-headers/releases/download/n8.1.24.14/nv-codec-headers-8.1.24.14.tar.gz'
        execute make PREFIX="${WORKSPACE}"
        execute make install PREFIX="${WORKSPACE}"
        build_done 'nv-codec' '8.1.24.14'
    fi
    CFLAGS+=' -I/usr/local/cuda/include'
    LDFLAGS+=' -L/usr/local/cuda/lib64'
    CONFIGURE_OPTIONS+=('--enable-cuda-nvcc' '--enable-cuvid' '--enable-nvenc' '--enable-cuda-llvm')

    if [ -z "${LDEXEFLAGS}" ]; then
        CONFIGURE_OPTIONS+=('--enable-libnpp')
    fi

    # https://arnon.dk/matching-sm-architectures-arch-and-gencode-for-various-nvidia-cards/ # CONFIGURE_OPTIONS+=('--nvccflags=-gencode arch=compute_52,code=sm_52')
    CONFIGURE_OPTIONS+=('--nvccflags=-gencode arch=compute_75,code=sm_75')
fi

# Vaapi doesn't work well with static links FFmpeg.
if [ -z "${LDEXEFLAGS}" ]; then
    # If the libva development SDK is installed, enable vaapi.
    if library_exists 'libva'; then
        if build 'vaapi' '1'; then
            build_done 'vaapi' '1'
        fi
        CONFIGURE_OPTIONS+=('--enable-vaapi')
    fi
fi

if build 'amf' '1.4.28'; then
    download 'https://github.com/GPUOpen-LibrariesAndSDKs/AMF/archive/refs/tags/v1.4.28.tar.gz' 'AMF-1.4.28.tar.gz' 'AMF-1.4.28'
    execute rm -rf "${WORKSPACE}"/include/AMF
    execute mkdir -p "${WORKSPACE}"/include/AMF
    execute cp -r "${PACKAGES}"/AMF-1.4.28/AMF-1.4.28/amf/public/include/* "${WORKSPACE}"/include/AMF/
    build_done 'amf' '1.4.28'
fi
CONFIGURE_OPTIONS+=('--enable-amf')

##
## FFmpeg
##

build 'ffmpeg' "${FFMPEG_VERSION}"
download "https://git.ffmpeg.org/gitweb/ffmpeg.git/snapshot/${FFMPEG_VERSION}.tar.gz" "FFmpeg-release-$FFMPEG_VERSION.tar.gz"
./configure \
    "${CONFIGURE_OPTIONS[@]}" \
    --disable-debug \
    --disable-doc \
    --disable-shared \
    --enable-pthreads \
    --enable-static \
    --enable-small \
    --enable-version3 \
    --extra-cflags="${CFLAGS}" \
    --extra-ldexeflags="${LDEXEFLAGS}" \
    --extra-ldflags="${LDFLAGS}" \
    --extra-libs="${EXTRALIBS}" \
    --pkgconfigdir="${WORKSPACE}"/lib/pkgconfig \
    --pkg-config-flags='--static' \
    --prefix="${WORKSPACE}" \
    --extra-version="${EXTRA_VERSION}"

execute make "-j${CPUS}"
execute make install

# MOVE BINARIES TO '/usr/bin'
sudo cp -f "${WORKSPACE}/bin/ffmpeg" "${INSTALLDIR}/ffmpeg"
sudo cp -f "${WORKSPACE}/bin/ffprobe" "${INSTALLDIR}/ffprobe"
sudo cp -f "${WORKSPACE}/bin/ffplay" "${INSTALLDIR}/ffplay"

# CHECK THAT FILES WERE COPIED TO THE ${INSTALLDIR}
if [ ! -f "${INSTALLDIR}/ffmpeg" ] || [ ! -f "${INSTALLDIR}/ffprobe" ] || [ ! -f "${INSTALLDIR}/ffplay" ]; then
    printf \
    "Failed to copy: %s to ${INSTALLDIR}\nFailed to copy: %s to ${INSTALLDIR}\nFailed to copy: %s to ${INSTALLDIR}\n" \
    "${INSTALLDIR}/ffmpeg" \
    "${INSTALLDIR}/ffprobe" \
    "${INSTALLDIR}/ffplay"
    echo
    exit 1
fi

echo
echo 'Build completed.'
echo
echo 'The binaries can be found in the following locations.'
echo
echo 'ffmpeg: ' "${INSTALLDIR}/ffmpeg"
echo 'ffprobe: ' "${INSTALLDIR}/ffprobe"
echo 'ffplay: ' "${INSTALLDIR}/ffplay"
echo
echo 'FFmpeg Version:'
echo '=================================================================='
ffmpeg -version

exit_fn
